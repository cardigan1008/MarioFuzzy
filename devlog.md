# 项目开发日志

要求：记录开发过程中的进度安排、任务分配、遇到的难题和解决的过程等

# 一、项目基本信息

| **小组名称** | MyTestGO!!!                |
| ------------ | -------------------------- |
| **项目成员** | 黄炜、倪匀博、刘学津、韦骐 |

## **1.1 项目目标**

**目标 1：基于图像识别建立针对游戏的模糊测试程序**

目标1.1：构建模糊测试种子调度组件

目标1.2：构建模糊测试输入生成组件

目标1.3：构建模糊测试输出分析组件

目标1.4：构建面向覆盖率的插装组件

**目标 2：基于github上获取的python版马里奥程序进行模糊测试实验并对结果进行分析**

目标2.2：构建从输入生成组件到游戏输出的连接组件

目标2.3：完成程序构建，运行模糊测试程序得到结果，并对结果进行分析

## **1.2 项目里程碑**

![image-20231230094635460](https://cardigan1008.oss-cn-hangzhou.aliyuncs.com/undefinedimage-20231230094635460.png)

# 二、项目流程

## **2.1 进度安排**

### 项目启动

时间：11.30-12.1

内容：

- 确定小组选题（基于图像识别和覆盖率分析的游戏模糊测试工具）
- 确定马里奥游戏为模糊测试针对对象，确定输入和输出的数据形式
- 确定程序总体架构，输入为五种

### 设计总体架构，实现助教提供的五种算子

时间：12.1-12.2

内容：

完成命令行指令parse部分，并完成transform部分，跑通fuzz demo

实现了以下六种算子，包括五种规定实现的算子和一种新增算子

| **算子名称** | **参数** | **描述**                                                     |
| ------------ | -------- | ------------------------------------------------------------ |
| CharFlip     | n/L/S    | 基础算子，字符翻转。n增量、L总长、S步长。将至多L个字符翻转（数值+n），每次翻转S个 |
| CharIns      | n/K      | 基础算子，字符插入。n位置数，K字符个数。在随机n个位置插入随机K个字符。 |
| CharDel      | n/K      | 基础算子，字符插入。n位置数，K字符个数。在随机n个位置删除随机K个字符。 |
| Havoc        | -        | 随机执行所有的基础算子若干次。                               |
| Splice       | -        | 将两个种子切分，之后将前后端拼接（遗传算法中的杂交操作）     |
| Shuffle      | -        | 对种子自身进行乱序操作                                       |

### 实现模糊测试的输入生成组件

时间：12.2-12.4

![image-20231230094836016](https://cardigan1008.oss-cn-hangzhou.aliyuncs.com/undefinedimage-20231230094836016.png)

### 里程碑1

时间：12.4

内容：实现模糊测试从输入种子到测试操作序列字符串生成的全过程，模糊测试基础框架架构确定

### 实现从输入生成组件到游戏输出的连接组件

时间：12.5-12.6

内容：

- 数据预处理，基于游戏文件数据进行抠图，得到主角马里奥、怪物等图像文件，便于图像结果识别
- 基于pyautogui和pygetwindow库，实现了从字符串的操作序列到pygame模拟键盘操作的映射，现在生成的字符串可以直接对游戏进行操作，同时实现了在每一步操作之后对游戏窗口进行截图，为图像识别存储结果

### 实现基于图像识别的模糊测试输出分析工具

时间：12.5-12.7

内容：

- 识别图像中的马里奥。提取马里奥图像的特征点，当游戏窗口截图传入后，提取截图特征，将二者匹配，返回马里奥在游戏中的状态
- 识别图像中的分数和金币。使用knn算法识别游戏中的特殊数字图像，训练了相关模型，能较为准确地返回游戏数据。

### 设计覆盖率测试指标

时间：12.7-12.10

内容：

- 由于游戏性质较为特殊，我们采用运行得分、金币数等条件来衡量测试的覆盖率。

### 里程碑2

时间：12.10

内容：

- 将操作序列所得截图输入给图像识别分析组件，实现获得对应分数、金币结果
- 实现从种子输入到分析结果输出的过程

### 实现种子筛选和能量调度

时间：12.10～12.13

内容：

- 对于种子先按得分进行排列，并按一定比例将种子序列切分为高分集和低分集，从低分集中选取部分种子和高分集组合成为待选集，从待选集中随机出种子进行调度，这样能在一定程度上避免后续变异序列只由高分组种子产生。
- 对于筛选出的种子，使用模拟退火算法进行种子进一步的变异，并按一定的接受比例或根据更好的表现将更好的种子加入到种子库中。

### 里程碑3

时间：12.13

内容：

- 完成种子筛选与能量调度与项目总框架的融合，等待进一步调试

### 进行模糊测试

时间：12.15

内容：

- 对接各组件之间关系，对MarioFuzzy项目整体进行调试，完成演示视频

## **2.2 任务分配**

倪匀博：构建模糊测试能量分配组件、构建模糊测试输入生成组件、说明文档编写

黄炜：构建从输入生成组件到游戏输出的连接组件、开发文档编写

刘学津：构建种子筛选和能量调度、面向覆盖率的指标分析与测试

韦骐：构建模糊测试输出分析组件

## **2.3 所遇难题和解决办法**

我们选择的游戏为马里奥1-1关卡的python实现版本

https://github.com/justinmeister/Mario-Level-1

### 问题1：pyautogui库报错

问题：AttributeError: dlsym(0x3c58645ec, objc_msgSendSuper_stret): symbol not found

查询github

https://github.com/moses-palmer/pynput/issues/420

发现是操作系统与pyautogui不兼容问题，且该问题一直没有得到解决

解决方法：改用windows系统进行操作

### 问题2：图像进行灰度匹配不准确

问题：用灰度匹配在截图中匹配mario模板图像时，由于背景的变化无法准确识别mario

查询发现opencv的matchTemplate方法进行灰度匹配，会将mario的png透明图片转为灰度图片，灰色的背景会和截图中mario的背景出现较大偏差，且游戏中的mario在一直变化，背景也在改变，导师准确率很低

解决方法：使用特征匹配，提取mario模板图片的特征点，与截图进行匹配，超过一定点数则认为匹配成功